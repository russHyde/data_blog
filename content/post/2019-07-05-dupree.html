---
title: '`dupree`'
author: Russ Hyde
date: '2019-07-05'
slug: dupree
categories: []
tags:
  - code-analysis
  - rstats
lastmod: '2019-07-05T18:06:58+01:00'
layout: post
type: post
highlight: no
---



<p><strong><code>dupree</code>: All files are the same, but some are samier than others</strong></p>
<p>… and on that dark and stormy night, the fabled <em>real programmers</em> came down
from Mount Partition. It is said they smell your code before it is even
written.</p>
<p>The sources of duplication are everywhere</p>
<p>We’ve all copied &amp; pasted stuff. “Screw it, it worked then and it’ll work
now!”. “Could you add a graph like you did the other week into this report?
You’ve got til yesterday”.</p>
<p>And to-be-fair, abstracting code is a bit more complicated than just bloating
out more code. Hell, if you write functions, you might have to test them…</p>
<p>I write a lot of analysis code. Sometimes I duplicate things in different
projects, sometimes I do it in the same project, sometimes I do it in the same
file. Most duplication doesn’t matter - I’ve written <code>library(dplyr)</code> in enough
scripts to know trivial duplication.</p>
<p>But if you have long bits of code that have substantial duplication between
them they can quickly come back to bite you.</p>
<p>I couldn’t find an R package to identify code duplication in/between scripts,
packages and projects so I wrote one:
<a href="https://github.com/russHyde/dupree"><code>dupree</code></a>.</p>
<p>Code duplication programs can be <em>really</em> complicated. This one isn’t. It
converts the code blocks in your files into sentences and finds stretches of
common ‘text’ within those sentences. There isn’t an abstract syntax tree in
sight.</p>
<p>Plus it’s slow.</p>
<p>Triumphantly slow.</p>
<p>If you’re working on a big package this is <em>not</em> the tool for you.</p>
<p>Given that my day job involves aligning lots of little 70-character sentences
against one massive 3-billion-character sentence, I was rather proud of how
slowly <code>dupree</code> aligns things against things.</p>
<p>Here’s some code</p>
<pre class="r"><code>library(dplyr)
data(iris)

summary(iris)</code></pre>
<pre><code>##   Sepal.Length    Sepal.Width     Petal.Length    Petal.Width   
##  Min.   :4.300   Min.   :2.000   Min.   :1.000   Min.   :0.100  
##  1st Qu.:5.100   1st Qu.:2.800   1st Qu.:1.600   1st Qu.:0.300  
##  Median :5.800   Median :3.000   Median :4.350   Median :1.300  
##  Mean   :5.843   Mean   :3.057   Mean   :3.758   Mean   :1.199  
##  3rd Qu.:6.400   3rd Qu.:3.300   3rd Qu.:5.100   3rd Qu.:1.800  
##  Max.   :7.900   Max.   :4.400   Max.   :6.900   Max.   :2.500  
##        Species  
##  setosa    :50  
##  versicolor:50  
##  virginica :50  
##                 
##                 
## </code></pre>
<pre class="r"><code>lm(Sepal.Length ~ Petal.Length, data = filter(iris, Species == &quot;setosa&quot;))</code></pre>
<pre><code>## 
## Call:
## lm(formula = Sepal.Length ~ Petal.Length, data = filter(iris, 
##     Species == &quot;setosa&quot;))
## 
## Coefficients:
##  (Intercept)  Petal.Length  
##       4.2132        0.5423</code></pre>
<pre class="r"><code>lm(Sepal.Length ~ Petal.Length, data = filter(iris, Species == &quot;versicolor&quot;))</code></pre>
<pre><code>## 
## Call:
## lm(formula = Sepal.Length ~ Petal.Length, data = filter(iris, 
##     Species == &quot;versicolor&quot;))
## 
## Coefficients:
##  (Intercept)  Petal.Length  
##       2.4075        0.8283</code></pre>
<pre class="r"><code>lm(Sepal.Length ~ Petal.Length, data = filter(iris, Species == &quot;virginica&quot;))</code></pre>
<pre><code>## 
## Call:
## lm(formula = Sepal.Length ~ Petal.Length, data = filter(iris, 
##     Species == &quot;virginica&quot;))
## 
## Coefficients:
##  (Intercept)  Petal.Length  
##       1.0597        0.9957</code></pre>
<p>Now I’ve saved that code in a temporary file. Let’s have a look for any
duplication within it.</p>
<pre class="r"><code>if (! &quot;dupree&quot; %in% installed.packages()){
  devtools::install_github(repo = &quot;russHyde/dupree&quot;, dependencies = FALSE)
}
  
library(dupree)

dupree::dupree(f, min_block_size = 10)</code></pre>
<pre><code>## # A tibble: 3 x 7
##   file_a             file_b             block_a block_b line_a line_b score
##   &lt;chr&gt;              &lt;chr&gt;                &lt;int&gt;   &lt;int&gt;  &lt;int&gt;  &lt;int&gt; &lt;dbl&gt;
## 1 /tmp/Rtmpn4g6X4/5… /tmp/Rtmpn4g6X4/5…       4       5      7      8   0.9
## 2 /tmp/Rtmpn4g6X4/5… /tmp/Rtmpn4g6X4/5…       5       4      8      7   0.9
## 3 /tmp/Rtmpn4g6X4/5… /tmp/Rtmpn4g6X4/5…       6       4      9      7   0.9</code></pre>
<p>Russ will be right back</p>
<!-- 
Are code smells still relevant to data analysts?

Be careful of overzealous deduplication: you might have to read that again
someday!
-->
